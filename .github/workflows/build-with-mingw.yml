name: Build with mingw
run-name: ${{ github.actor }} is building and testing with mingw
on:
  push:
    branches:
      - 'master'
      - 'work*'
      - 'build/*'
      - 'build-mingw/*'
jobs:
  Build-with-mingw:
    runs-on: windows-latest

    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: echo
        shell: bash
        run: |
          echo bash00

      - name: install tools
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          install: >-
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-icu
            mingw-w64-x86_64-python
            mingw-w64-x86_64-ruby
            mingw-w64-x86_64-pkg-config
            bison
            texinfo

      - name: check version of tools
        shell: bash
        run: |
          bash --version
          gcc --version
          perl --version
          python --version
          python3 --version
          ruby --version
          uname
          uname -r
          uname -a
          which bash

      - name: echo
        shell: bash
        run: |
          echo bash01

      - name: check version of tools
        shell: msys2 {0}
        run: |
          echo haha00
          bash.exe --version
          echo haha00
          echo $BASH_VERSION
          echo haha01
          gcc.exe --version
          echo haha02
          perl.exe --version
          echo haha03
          python --version
          echo haha04
          # python3 --version
          # echo haha05
          # ruby --version
          echo haha06
          pkg-config --libs --cflags icu-uc icu-io
          yacc --version || echo -e "**\n** Cannot find yacc\n**"
          echo haha07
          bison --version || echo -e "**\n** Cannot find bison\n**"
          echo haha08
          byacc --version || echo -e "**\n** Cannot find byacc\n**"
          echo haha09
          makeinfo --version || echo -e "**\n** Cannot find makeinfo\n**"
          echo haha10
      - name: configure & make
        shell: msys2 {0}
        run: |
          pwd
          ls .
          mkdir ./Work
          cd ./Work
          ../source/configure
          cat config.log
          make
          echo "make: done"
      - name: test
        shell: msys2 {0}
        run: |
          pwd
          cd ./Work
          ./gha_sb.exe --version
          ./gha_sb.exe --icuversion

          touch aaa.txt
          ./gha_sb.exe --stdio
          echo "stdin is redirect:"
          ./gha_sb.exe --stdio < aaa.txt
          echo "stdin is pipe:"
          cat aaa.txt | ./gha_sb.exe --stdio
          echo "stdout is redirect:"
          ./gha_sb.exe --stdio < aaa.txt > bbb.txt
          cat bbb.txt
          echo "stdout is pipe:"
          cat aaa.txt | ./gha_sb.exe --stdio | tee bbb.txt
          cat bbb.txt

          export BinDir=. ExeExt=.exe srcdir=../source
          $srcdir/testdata/gha_sb-test.sh
          cat ./testdata/*.log || echo ""

          make check || echo "** failed"
          cat ./testdata/*.log || echo ""

      - name: test codepage msys2
        shell: msys2 {0}
        run: |
          pwd
          cd ./Work
          ./gha_sb.exe --codepage

      #- name: test codepage bash
      #  shell: bash
      #  run: |
      #    pwd
      #    cd ./Work
      #    ./gha_sb.exe --codepage

      - name: test codepage cmd
        shell: cmd
        run: |
          chcp
          cd .\Work
          .\gha_sb.exe --codepage
          bash .\gha_sb.exe --codepage

          chcp 932
          cd .\Work
          .\gha_sb.exe --codepage
          bash .\gha_sb.exe --codepage

          chcp 65001
          cd .\Work
          .\gha_sb.exe --codepage
          bash .\gha_sb.exe --codepage

      - name: test codepage powershell
        shell: pwsh
        run: |
          chcp
          cd .\Work
          .\gha_sb.exe --codepage
          bash .\gha_sb.exe --codepage

          chcp 932
          cd .\Work
          .\gha_sb.exe --codepage
          bash .\gha_sb.exe --codepage

          chcp 65001
          cd .\Work
          .\gha_sb.exe --codepage
          bash .\gha_sb.exe --codepage

      - run: echo "⛄ This job's status is ${{ job.status }}."
